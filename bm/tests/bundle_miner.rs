use bee_ternary::{T1B1Buf, TritBuf, TryteBuf};
use bm::bundle_miner::{
    absorb_and_get_normalized_bundle_hash, create_obsolete_tag, get_outgoing_bundle_builder,
    increase_essense, mining_worker, prepare_keccak_384, trit_buf_to_string,
    update_essense_with_new_obsolete_tag, BundleMinerBuilder, BundleMinerEvent, StopMiningCriteria,
    EQUAL_TRAGET_HASH, LESS_THAN_MAX_HASH,
};

#[tokio::test]
pub async fn test_get_outgoing_bundle_builder() {
    let transactions = vec![
        "999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999PEQMOYMQWULOGOTWLTJ9TADSOIVBWHDDJVDEVPHJITTZWSGPLEXJNGL99IQX9FHQAZZJOWYSYNNGXTX9ZCTAYNJRBA999999999999999999GPJNITY99999999999999999999D9DWACD99999999999C99999999RV9BHSYRJLJHR9RGEHWHQUOKYQRQ9Q9SKPIAYO9PAVKJLZYUHHOBDLWUJMEAZZIQN9DVJGDIATKLAGCYYQKHTXBACSUXBXHWEGNMZRGVDNRBEFHBZ9K9PAJN9BFVOGWKPUCFRSLPYYKJZOSOYGIFXHJPKPRML99999PWRRZN9UNKJJDDCLSFPKT9YHCWGETPD9ELURTFPDUKBJSQDTPQXLEWYYQKETKUUQL9HHBTDMQNRQA9999TB9CONFIRMER999999999999999RTSAVHHQF999999999MMMMMMMMMKBRKRSIQLGARC9ZIWUQ9DXU9WQZ",
        "VNJ9AEJMYTLGPKHYRJKHAVGBMZJAEFDVKBCWVGSBYYS9TLJZWKRIOMAJZQPPEUOQBMDIKRZTZCKERXXQWZGM9VJKRWEBGHUUBGLSWYGCIOBVXJJ9TSQOEQNIELMGOXSIKNQOZXS9IUMGBMQEBDKS9LNMMJBCLNTJNBUEXAEGLLQLMTS9IMGFYRSUKZ9GQYLDCQUBKISDRXAQWOQARPIWBJIEYEWJXQYIXLMP9XU9CMDYBMZPVUDSLVZTXDYLX9TNCHTGQFJLSKLDBUGXARC9KQANDMJYPOTXSCSZYYETRUEJZFQMYQYTDLELZXIDKJDMVZLYJDZKDSYFRIRMJKRKKFCYTIEFGKARPDPAQDDHIZHGPFQQKBTJB9MCJUSPBYMYTMNIYHJXLADJYINDQNMPDQRHJLDPUEOHP9ZXCSYQFRSLWHKORFFVLEPABDUWE9HHDEZGTYELARFUA9XRHMWQXSJYJEQ9NYWSPWAU9CKEMYZT9QDOJMJJDLMWPJBQGOKZBVMTKMUTNKJXSXOQSUU9UPCDBULMDBOZJWPVSQCGY9XVERGIPWQZRMAMDYKLIQSBPHYXTTUDVAZ9BGEHZG9KGQWTORBRKVQBXXUJVBSTIHHCUIYYQGQJDCLNKNQ9ALCFVMOIOSDCEUALNNIXWNAFBNWKXAAJKBNVWUQVHESOBK9GQMWXEQMHQFZ9CZMXYZRPQDKBCORMJEF9CEF9QSIOLTDZXI9JTEMBBVXODIGMADRMPVZPWLAKXSOVFDRLFMXJRAMUFPLFHVYVHVNCXMDPAGMLVMODJLGONZQ9LMRY9BRLLBXYTHFCZAEH9ZCVXFJELPP9UTLEVONGYVENKDSRBMEJUZHTANZMFNBHNKFMXRVQRTTDDUMFTKHB9HBQAL9KQBRQASJJSARGCZOJQQEDMZYJJQYQRVELKPHBGDADRDMKMYUMR9GZTNVVTZT9FDSDKYODLRTMHSYDRGLBJIASUAOKXJVOSOSDCMEAK9BWOUZUXXRXCWUOSRXWRS99OCITHIMU9RKDHJJJWWEGYJHRQUACGMFXCEVRERGJSEKLDUDXAL9PVU9GQQUBWTMIFYGORWGLCVGRHXMCPJKRKVHPEYWDLNEMHQYNXLHBYRJAF9CYHBTPLICYPLSNXWRDOYMNGTQWUULVBHAGRSRAWZNILTTZOODCFPOEAHSFTJYKHVV9NOVJJVHKYDEZVLCQTFDZBXJ9YMFFIU9LTIKGOGWZAQ9QYIHCZ9MCSRHMBIWKQHDXLJOTAPWYITAJADUAKAPJQCJJ9RONBMCVJQXDV9QPKYXZZOURPGEGAJEKLCUSI9WWHOFFR9JQBW9PZKQTUBID9QHOPYX9WOQJQEUZTPDMASDKQCH9GHQSCMZUDMVAUZTWQHRYNAUVHPNRGLOCXTCUTETPILSNIZDIPBV9JWUJRSRXYLPBEQTJEYOGRVUBLNWWRAFPADN9NALCEYFUEOEYKS9YHMSKCUWFAZW9GPHXPKQMTMY9WXIDNXFYIXYXKAYOPALYTBGNHZOLXVKMIGUHARABDRWH9VXJWZNWBVLJUAPJXEYJY9LHMNZGQQLUSSMTPKVLIJENAGVICZJ9TEMJVJQX9MRDHQQJUNQPTRUWM9FDJ9EUNEGZV9VOFNFLEKSIYYFTHHVMVQCKBAEUTSIXXNPUEPKWMRCLTGHOLNQKPIMMNJYBDQKY9PAVXMFWHZFBJXNFVTHNXABNFLKLHNOHFEYXOUHIH9WZWBCRHMVVFLJTWPQRWPFQGPYYW9WUJXADWWZGWSOPPCGGLNAU9IHWHDAOWSMACHVQUYZYKHQEHUVXRE9MHTUETTLRCWKFADNOZTGFEAIFMIUCLUYSHPKKXMROXMCUPNLZAMWIPXGAZI9QFZ9EMQXMM9UQCWCOJKRCAIMQ9DWRCXKLILTITAU9RFNRIB9TIPJJ9JJRFJFFMOZCOMDENCD9UTUGPRGROFMBGWMKQNZWZMGHYZFTDA9TKIO9OXIXRICNWZHSRGKYXFGYEXHSSTZZFHFBSXODXIDSQIJZG9FJIUTRTIUPZLODGEGPLNB9IDNBXNSZDWUKJOWRTMBGDWQSDLVJVXFLINHAAKLBXSKIDADRUXQTP9BYLEASUBWLPMVJUAZQNMZJYDHLSGRFUWPARUSLXDHILLIEDNEWDMLSESVVFSGQPCBKHEOCYRUWUDDMMBS999NZNHWAMXKFIJWVGRYH9STNSYUWSSZRAEAULFJKUHXTLANQDFAUBKSK9OGMQGXHYUTRNIGIPFXBMUXYWPRQHY99999999999999999999999999999999999999999999D9DWACD99A99999999C99999999RV9BHSYRJLJHR9RGEHWHQUOKYQRQ9Q9SKPIAYO9PAVKJLZYUHHOBDLWUJMEAZZIQN9DVJGDIATKLAGCYYANUD99KXNEMCXJQXNPBWIXCUFZMYFYLLDRTOR9VNZD9KULOLDOVEZGSOLJOMUDSVSPYHVQZZQX9ZA9999PWRRZN9UNKJJDDCLSFPKT9YHCWGETPD9ELURTFPDUKBJSQDTPQXLEWYYQKETKUUQL9HHBTDMQNRQA9999TB9CONFIRMER999999999999999YCRAVHHQF999999999MMMMMMMMMYF9QTDLHAXTIUUYW99RYRBAMH9R",
        "VXNWKEJDTZIWMADEGVNKZNDQFMACCM9DMGQKNCZGSEQAFTRYRTVJBJYEMVLHHFEUKWOAWSHXIARXKNYG9JYUOL9PQCIMZTFVUI9GJOCCARVVWVXNUASUPCXITDFLPLZMIYRUQYYGTJCFVCQQHCUBYBGDOLVKBYARXWMIJWLBFHECCTQAUQOAWXKKKLNHGHSOWMGJPQRENOAJRROKRITCNGVD99JEVZBPBFBQL9OVEG9MYOYEHIAKLTDUEU9HGO9II9F9LT9KXUOGWDPROCEZDJLKOUWEZYQMVUYCXOVCRCIHLFHGVXSKZVFBEHECTHRWZKSWPKEKIQNLJXAANHPBPOQUNFTCJS9RGLCVMSNWESLMNANNHWFLDCBOYZVZSIRGQXEWTHJ9VDQZ9P9ZFRPV9PPXGUENUGQXHTWJECJRRLUNEDZTOCUJRIQAIHAMOVCFKNAHGJXHUAMHJRBTEQMFAOGMRMFGLTBXDEQZKDMUHZDFPPTZPVSCJJYETNR9TFQIXKXMMIJXEIBGXPLGAALHHCKHMQD9LZUAAJVAAZXS99NNQDGBKLJZFA9RXCAISGPHTLUSIBDXKXFVNHVMMPINXQTOIXBAVMDSMRSDLOUFGTHKCEWVF9KPDXNHQWNJCYISHUWGHAGCZXXWLBMYRMOVXWSOZRNMCQBRUWNWCDOTHTOF9QDQZPRMMUXZXBGQEUNDMAZIN9JVNSPOKWZLV9QDYEAPDAQKWNSRJTPIIMGJMEIPPW9PINRTAWXQVUCIEQPYYFEBNBXNGCGFIKDINSD9VQLQOTMVZDUUHDTECYMAYXWQOO9VPSIRV9ABIYYHGTOEGDWLVFGI9SVIQKVJDMATCPK9VAWQEWVVZXFJPBYFZ9RAJXMNHAAOSJAIIDXBORNCHGNZQOZIFMDHQTEPQAVZVQGJOAH9LLZAPEGPSMFVWRHC9N9MZDCYZJMPVVLQVBLAFKUPWEUPVCHXUKUNBJGERNKNQ9EOGJ9P9VKTDEULWHPJSPESJJHZPV9YLVCVYPVTJLC9CMBWBWBLVKNBFUBURRVI9QUFCVOHPU9OVHBFPLMNDLIGOLZFJQNBXDBCOIOYZPDCOZJQVVVHCRVWYUDXCKKIVDPPCGTYUYWKIEUASYU99COMHKKMCQ9S9GKWZYKSKVFFSVDLZFSJHAP9DYHK9HRZKIIFGXUHUXNQESJUUKTGZUNGHOSYSPIRTUJIGFXASBADTUUAXRXYWL9DBGPLXLBXOLPMNZDFAQBJCBUMXEJENNAD9YVTMLPZUQZGWQPPK9OKBNDAHMWPQRA9WH9QOXWCVEYYXNNGRDHPLG9FOWAUUYJVBHPKPNIETEZMBHQZNFBHEBKBYCDKUPNDZOZKGG9SJFXYPILVDEFSCQZOILKCWJ9PUBG9UQOSXXIMJBQMBKSVTCLHQA9OQSKAFMMPGCNJNVPOGPWLUP9HHRRWNBGXTDDAUCCAZXNKOTQTHHMBNGVKKTNMGBIQYE9NKAUYOCQVESJDLLYGRVTPU99GXQEXZQJOPINWXLBMGSKSKZLAMLCPATKEAYLOTG9YYHMQXWVCDJYT9LNGDCKOVGUPTHWYQCKPKTYEESZOLHZXCICKGCY9GTOF9OLUZYSJFSBDDDPGSMQKGGWHDTWAAJJYKZUIGXMYHZJ9RHK9DCHNIXOAFQPYAWYXQUKGOF9P9EJPPWYSHLZMGQGQ9JCEBNEJMFFKVOWNWZUKDATNABDDNVFZXXYZYYUGZFBSNQMCH9YBCRYSAFSEHUIDEYFCLEPZVNBFKPXNYJFMVAKWTKDUKMUNXUWMXHJSLTLYUZNBCPBYCYXZHWQWVYGQKMJ9W9YRVREXCBCANHQVYZQYLNAORXNOBKG9NGBAZAAWFVGQMGVQWUWRUSMMFNFEXWJEVYARMRNNIFDFXZNBHYTWMOGP9EXEER9WAHPPRUYEHVBAGUBUCVDAHVBPFTIB9OBOGIBWKRHNVTIOMTVOKSJQLGYMVSOZU99IYGNIMKVWYIRXLEFVZCUIZRONZLVY9VVBNAMYAJNMCUMUSAPHIFPZXKWBNNUZNESNZQIKIZUTZXCJPAPDD99D9AOSXUDPIQTES9OZXMMYUMPM9IPJYOUFVXCI9VVJB9SQJGTBDYFVKSDMQXHNULAFTWLH9ZWWDIADZCJEOOZDWXLMDZXLQASZWYYJYHNJ9EVTDUSKYGWMMBS999NZNHWAMXKFIJWVGRYH9STNSYUWSSZRAEAULFJKUHXTLANQDFAUBKSK9OGMQGXHYUTRNIGIPFXB999999999999999999999999999999999999999999999999999999D9DWACD99B99999999C99999999RV9BHSYRJLJHR9RGEHWHQUOKYQRQ9Q9SKPIAYO9PAVKJLZYUHHOBDLWUJMEAZZIQN9DVJGDIATKLAGCYYOWEUPIHBAQIPHAVQQKAGGOZEGBECSDHFXTOMJZITBGDZNCIQAHEWOIZ9QYQAPMUGYBVINPPTPKTM99999PWRRZN9UNKJJDDCLSFPKT9YHCWGETPD9ELURTFPDUKBJSQDTPQXLEWYYQKETKUUQL9HHBTDMQNRQA9999TB9CONFIRMER999999999999999UHQAVHHQF999999999MMMMMMMMM9I9YROZDZQKJUSQIUMFAFE9YIL9",
        "999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999999LMR9WUQTKFOGKGCIZQUURDDUYIPJWKVHDLLKTXGMJCIHJJCRJPPDDNKLHDABNHZPIPPAIOCM9ZHVMQMODKLBDQBRIRB99999999999999999999999999999999999999999999D9DWACD99C99999999C99999999RV9BHSYRJLJHR9RGEHWHQUOKYQRQ9Q9SKPIAYO9PAVKJLZYUHHOBDLWUJMEAZZIQN9DVJGDIATKLAGCYYPWRRZN9UNKJJDDCLSFPKT9YHCWGETPD9ELURTFPDUKBJSQDTPQXLEWYYQKETKUUQL9HHBTDMQNRQA9999PWRRZN9UNKJJDDCLSFPKT9YHCWGETPD9ELURTFPDUKBJSQDTPQXLEWYYQKETKUUQL9HHBTDMQNRQA9999TB9CONFIRMER999999999999999QOQAVHHQF999999999MMMMMMMMMIGZZ99H9INKISZ9KRIXIJZIZ9CW",
    ];
    let _ = get_outgoing_bundle_builder(
        &transactions
            .iter()
            .map(|t| {
                TryteBuf::try_from_str(&t.to_string())
                    .unwrap()
                    .as_trits()
                    .encode()
            })
            .collect::<Vec<TritBuf<T1B1Buf>>>(),
    )
    .await
    .unwrap();
}

#[tokio::test]
pub async fn test_obsolete_tag_creation() {
    let increment: i64 = 3;
    let worker_id: i32 = 0;
    let essences = vec![
        "EDIKZYSKVIWNNTMKWUSXKFMYQVIMBNECNYKBG9YVRKUMXNIXSVAKTIDCAHULLLXR9FSQSDDOFOJWKFACD",
        "A99999999999999999999999999999999999999999999999999999999999999999999999C99999999",
        "BMLAF9QKVBYJTGHTGFFNOVDTGEMA9MSXGTJYSRRHEYTMMKRMQYETPJVAADGYLPYMGBJERKLJVUZUZYRQD",
        "Z99999999999999999999999999999999999999999999999999999999999999A99999999C99999999",
        "BMLAF9QKVBYJTGHTGFFNOVDTGEMA9MSXGTJYSRRHEYTMMKRMQYETPJVAADGYLPYMGBJERKLJVUZUZYRQD",
        "999999999999999999999999999999999999999999999999999999999999999B99999999C99999999",
        "BMLAF9QKVBYJTGHTGFFNOVDTGEMA9MSXGTJYSRRHEYTMMKRMQYETPJVAADGYLPYMGBJERKLJVUZUZYRQD",
        "999999999999999999999999999999999999999999999999999999999999999C99999999C99999999",
    ];
    let target_hash =
        "NNNNNNFAHTZDAMSFMGDCKRWIMMVPVISUYXKTFADURMAEMTNFGBUMODCKQZPMWHUGISUOCWQQL99ZTGCJD";
    let kerl = prepare_keccak_384(
        &essences[..essences.len() - 1]
            .iter()
            .map(|t| {
                TryteBuf::try_from_str(&t.to_string())
                    .unwrap()
                    .as_trits()
                    .encode()
            })
            .collect::<Vec<TritBuf<T1B1Buf>>>(),
    )
    .await;
    let mut last_essence: TritBuf<T1B1Buf> = TryteBuf::try_from_str(essences[essences.len() - 1])
        .unwrap()
        .as_trits()
        .encode();

    let obselete_tag = create_obsolete_tag(increment, worker_id).await;
    last_essence = update_essense_with_new_obsolete_tag(last_essence, &obselete_tag).await;
    let hash = absorb_and_get_normalized_bundle_hash(kerl, &last_essence).await;

    let hash_str = trit_buf_to_string(&hash).await;
    assert_eq!(String::from(target_hash), hash_str);
}

#[tokio::test]
pub async fn test_obsolete_tag_increment() {
    let increment: i64 = 0;
    let worker_id: i32 = 0;
    let essences = vec![
        "EDIKZYSKVIWNNTMKWUSXKFMYQVIMBNECNYKBG9YVRKUMXNIXSVAKTIDCAHULLLXR9FSQSDDOFOJWKFACD",
        "A99999999999999999999999999999999999999999999999999999999999999999999999C99999999",
        "BMLAF9QKVBYJTGHTGFFNOVDTGEMA9MSXGTJYSRRHEYTMMKRMQYETPJVAADGYLPYMGBJERKLJVUZUZYRQD",
        "Z99999999999999999999999999999999999999999999999999999999999999A99999999C99999999",
        "BMLAF9QKVBYJTGHTGFFNOVDTGEMA9MSXGTJYSRRHEYTMMKRMQYETPJVAADGYLPYMGBJERKLJVUZUZYRQD",
        "999999999999999999999999999999999999999999999999999999999999999B99999999C99999999",
        "BMLAF9QKVBYJTGHTGFFNOVDTGEMA9MSXGTJYSRRHEYTMMKRMQYETPJVAADGYLPYMGBJERKLJVUZUZYRQD",
        "999999999999999999999999999999999999999999999999999999999999999C99999999C99999999",
    ];
    let target_hash =
        "NNNNNNFAHTZDAMSFMGDCKRWIMMVPVISUYXKTFADURMAEMTNFGBUMODCKQZPMWHUGISUOCWQQL99ZTGCJD";
    let kerl = prepare_keccak_384(
        &essences[..essences.len() - 1]
            .iter()
            .map(|t| {
                TryteBuf::try_from_str(&t.to_string())
                    .unwrap()
                    .as_trits()
                    .encode()
            })
            .collect::<Vec<TritBuf<T1B1Buf>>>(),
    )
    .await;
    let mut last_essence: TritBuf<T1B1Buf> = TryteBuf::try_from_str(essences[essences.len() - 1])
        .unwrap()
        .as_trits()
        .encode();

    let obselete_tag = create_obsolete_tag(increment, worker_id).await;
    last_essence = update_essense_with_new_obsolete_tag(last_essence, &obselete_tag).await;
    let last_essence = increase_essense(last_essence).await;
    let last_essence = increase_essense(last_essence).await;
    let last_essence = increase_essense(last_essence).await;
    let hash = absorb_and_get_normalized_bundle_hash(kerl, &last_essence).await;

    let hash_str = trit_buf_to_string(&hash).await;
    assert_eq!(String::from(target_hash), hash_str);
}

#[tokio::test]
pub async fn test_worker() {
    let increment: i64 = 0;
    let worker_id: i32 = 0;
    let essences = vec![
        "EDIKZYSKVIWNNTMKWUSXKFMYQVIMBNECNYKBG9YVRKUMXNIXSVAKTIDCAHULLLXR9FSQSDDOFOJWKFACD",
        "A99999999999999999999999999999999999999999999999999999999999999999999999C99999999",
        "BMLAF9QKVBYJTGHTGFFNOVDTGEMA9MSXGTJYSRRHEYTMMKRMQYETPJVAADGYLPYMGBJERKLJVUZUZYRQD",
        "Z99999999999999999999999999999999999999999999999999999999999999A99999999C99999999",
        "BMLAF9QKVBYJTGHTGFFNOVDTGEMA9MSXGTJYSRRHEYTMMKRMQYETPJVAADGYLPYMGBJERKLJVUZUZYRQD",
        "999999999999999999999999999999999999999999999999999999999999999B99999999C99999999",
        "BMLAF9QKVBYJTGHTGFFNOVDTGEMA9MSXGTJYSRRHEYTMMKRMQYETPJVAADGYLPYMGBJERKLJVUZUZYRQD",
        "999999999999999999999999999999999999999999999999999999999999999C99999999C99999999",
    ];
    let target_hash =
        "NNNNNNFAHTZDAMSFMGDCKRWIMMVPVISUYXKTFADURMAEMTNFGBUMODCKQZPMWHUGISUOCWQQL99ZTGCJD";
    mining_worker(
        increment,
        worker_id,
        essences
            .iter()
            .map(|t| {
                TryteBuf::try_from_str(&t.to_string())
                    .unwrap()
                    .as_trits()
                    .encode()
            })
            .collect::<Vec<TritBuf<T1B1Buf>>>(),
        TryteBuf::try_from_str(&target_hash.to_string())
            .unwrap()
            .as_trits()
            .encode(),
        EQUAL_TRAGET_HASH,
    )
    .await;
}

#[test]
pub fn test_equal_target_hash_criterion() {
    let mined_hash = "NWAIJHLGJJCHKJL9EELLKKILAGK";
    let target_hash_true = "NWAIJHLGJJCHKJL9EELLKKILAGK";
    let target_hash_false = "NWAIJHLGJJCHK9L9EELLKKILAGK";
    let target_hash_true_trit_buf = TryteBuf::try_from_str(&target_hash_true.to_string())
        .unwrap()
        .as_trits()
        .encode();
    let target_hash_false_trit_buf = TryteBuf::try_from_str(&target_hash_false.to_string())
        .unwrap()
        .as_trits()
        .encode();
    let mined_hash_trit_buf = TryteBuf::try_from_str(&mined_hash.to_string())
        .unwrap()
        .as_trits()
        .encode();
    assert_eq!(
        true,
        LESS_THAN_MAX_HASH.judge(&mined_hash_trit_buf, &target_hash_true_trit_buf)
    );
    assert_eq!(
        false,
        LESS_THAN_MAX_HASH.judge(&mined_hash_trit_buf, &target_hash_false_trit_buf)
    );
}

#[test]
pub fn test_less_than_max_hash_criterion() {
    let max_hash_true = "NWAIJHLGJJCHKJL9EELLKKILAGK";
    let max_hash_false = "NOPGBAGZHGZBJZHUC9TR9HFNTFE";
    let mined_hash =
        "NOPGBAGZHGZBJZHUC9TR9HFOTFEZXOCUJOUXVVMXMB9JJTYKGLOATSMMMJNU9IQHSWVEHBKOONQAZENGB";
    let max_hash_true_trit_buf = TryteBuf::try_from_str(&max_hash_true.to_string())
        .unwrap()
        .as_trits()
        .encode();
    let max_hash_false_trit_buf = TryteBuf::try_from_str(&max_hash_false.to_string())
        .unwrap()
        .as_trits()
        .encode();
    let mined_hash_trit_buf = TryteBuf::try_from_str(&mined_hash.to_string())
        .unwrap()
        .as_trits()
        .encode();
    assert_eq!(
        true,
        LESS_THAN_MAX_HASH.judge(&mined_hash_trit_buf, &max_hash_true_trit_buf)
    );
    assert_eq!(
        false,
        LESS_THAN_MAX_HASH.judge(&mined_hash_trit_buf, &max_hash_false_trit_buf)
    );
}

#[test]
pub fn test_bundle_miner_builder() {
    let essences = vec![
        "EDIKZYSKVIWNNTMKWUSXKFMYQVIMBNECNYKBG9YVRKUMXNIXSVAKTIDCAHULLLXR9FSQSDDOFOJWKFACD",
        "A99999999999999999999999999999999999999999999999999999999999999999999999C99999999",
        "BMLAF9QKVBYJTGHTGFFNOVDTGEMA9MSXGTJYSRRHEYTMMKRMQYETPJVAADGYLPYMGBJERKLJVUZUZYRQD",
        "Z99999999999999999999999999999999999999999999999999999999999999A99999999C99999999",
        "BMLAF9QKVBYJTGHTGFFNOVDTGEMA9MSXGTJYSRRHEYTMMKRMQYETPJVAADGYLPYMGBJERKLJVUZUZYRQD",
        "999999999999999999999999999999999999999999999999999999999999999B99999999C99999999",
        "BMLAF9QKVBYJTGHTGFFNOVDTGEMA9MSXGTJYSRRHEYTMMKRMQYETPJVAADGYLPYMGBJERKLJVUZUZYRQD",
        "999999999999999999999999999999999999999999999999999999999999999C99999999C99999999",
    ];
    let target_hash =
        "NNNNNNFAHTZDAMSFMGDCKRWIMMVPVISUYXKTFADURMAEMTNFGBUMODCKQZPMWHUGISUOCWQQL99ZTGCJD";

    let _ = BundleMinerBuilder::new()
        .core_threads(1)
        .mining_workers(5)
        .essences(
            essences
                .clone()
                .iter()
                .map(|t| {
                    TryteBuf::try_from_str(&(*t).to_string())
                        .unwrap()
                        .as_trits()
                        .encode()
                })
                .collect::<Vec<TritBuf<T1B1Buf>>>(),
        )
        .target_hash(
            TryteBuf::try_from_str(&target_hash.to_string())
                .unwrap()
                .as_trits()
                .encode(),
        )
        .timeout_seconds(10)
        .finish();
}

#[test]
pub fn test_bundle_miner_run() {
    let essences = vec![
        "EDIKZYSKVIWNNTMKWUSXKFMYQVIMBNECNYKBG9YVRKUMXNIXSVAKTIDCAHULLLXR9FSQSDDOFOJWKFACD",
        "A99999999999999999999999999999999999999999999999999999999999999999999999C99999999",
        "BMLAF9QKVBYJTGHTGFFNOVDTGEMA9MSXGTJYSRRHEYTMMKRMQYETPJVAADGYLPYMGBJERKLJVUZUZYRQD",
        "Z99999999999999999999999999999999999999999999999999999999999999A99999999C99999999",
        "BMLAF9QKVBYJTGHTGFFNOVDTGEMA9MSXGTJYSRRHEYTMMKRMQYETPJVAADGYLPYMGBJERKLJVUZUZYRQD",
        "999999999999999999999999999999999999999999999999999999999999999B99999999C99999999",
        "BMLAF9QKVBYJTGHTGFFNOVDTGEMA9MSXGTJYSRRHEYTMMKRMQYETPJVAADGYLPYMGBJERKLJVUZUZYRQD",
        "999999999999999999999999999999999999999999999999999999999999999C99999999C99999999",
    ];
    let target_hash =
        "NNNNNNFAHTZDAMSFMGDCKRWIMMVPVISUYXKTFADURMAEMTNFGBUMODCKQZPMWHUGISUOCWQQL99ZTGCJD";
    let expected_essence =
        "999999999999999999999999999C99999999999999999999999999999999999C99999999C99999999";
    let expected_essence: TritBuf<T1B1Buf> = TryteBuf::try_from_str(&expected_essence.to_string())
        .unwrap()
        .as_trits()
        .encode();
    let mut bundle_miner = BundleMinerBuilder::new()
        .core_threads(1)
        .mining_workers(5)
        .essences(
            essences
                .clone()
                .iter()
                .map(|t| {
                    TryteBuf::try_from_str(&(*t).to_string())
                        .unwrap()
                        .as_trits()
                        .encode()
                })
                .collect::<Vec<TritBuf<T1B1Buf>>>(),
        )
        .target_hash(
            TryteBuf::try_from_str(&target_hash.to_string())
                .unwrap()
                .as_trits()
                .encode(),
        )
        .timeout_seconds(10)
        .finish();
    if let BundleMinerEvent::MinedEssence(mined_essence) = bundle_miner.run(EQUAL_TRAGET_HASH) {
        assert_eq!(mined_essence, expected_essence);
    } else {
        panic!();
    }
}
